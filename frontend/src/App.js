import React, { useState } from 'react';
import './App.css';
import logo from './logo_with_name.png';
import thumbUpImg from './Good_hand.png';
import thumbDownImg from './Bad_hand.png';
import WritePage from './WritePage';
import NewsDetailPage from './NewsDetailPage';
import LoginPage from './LoginPage';
import RegisterPage from './RegisterPage';

function App() {
  const [page, setPage] = useState('main');
  const [showThemeMenu, setShowThemeMenu] = useState(false);
  const [themePage, setThemePage] = useState(null); // 'Ï†ïÏπò', 'Í≥ºÌïô', 'Í≤ΩÏ†ú'
  const [popularArticles, setPopularArticles] = useState([]);
  const [selectedNews, setSelectedNews] = useState(null);
  const [currentPopularPage, setCurrentPopularPage] = useState(1);
  const [currentLatestPage, setCurrentLatestPage] = useState(1);
  const [currentThemePage, setCurrentThemePage] = useState(1);
  const articlesPerPage = 5;
  const [user, setUser] = useState(null); // Î°úÍ∑∏Ïù∏ Ïú†Ï†Ä Ï†ïÎ≥¥ (nullÏù¥Î©¥ ÎπÑÎ°úÍ∑∏Ïù∏)

  // Ï£ºÏ†úÎ≥Ñ Í∏∞ÏÇ¨ (Ìï≠ÏÉÅ ÏÉÅÌÉú ÏÑ†Ïñ∏ Ïù¥ÌõÑÏóê ÏúÑÏπò)
  const politicsArticles = popularArticles.filter(a => a.category === 'Ï†ïÏπò');
  const scienceArticles = popularArticles.filter(a => a.category === 'Í≥ºÌïô');
  const economyArticles = popularArticles.filter(a => a.category === 'Í≤ΩÏ†ú');

  // ÎìúÎ°≠Îã§Ïö¥ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Ìûò Ï≤òÎ¶¨
  const themeMenuRef = React.useRef();
  React.useEffect(() => {
    if (!showThemeMenu) return;
    function handleClickOutside(e) {
      if (themeMenuRef.current && !themeMenuRef.current.contains(e.target)) {
        setShowThemeMenu(false);
      }
    }
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [showThemeMenu]);

  React.useEffect(() => {
    async function fetchMockArticles() {
      try {
        const res = await fetch("http://localhost:8000/news");
        if (!res.ok) throw new Error("ÏÑúÎ≤Ñ Ïò§Î•ò");
        const data= await res.json();
        setPopularArticles(data);
      } catch (err) {
        console.error("Îâ¥Ïä§ API Ìò∏Ï∂ú Ïã§Ìå®:", err);
      }
    fetchMockArticles();
    }
  }, []);

  // Ï†ïÎ†¨: Ïù∏Í∏∞ÎèÑ (Ï¢ãÏïÑÏöî + Ïã´Ïñ¥Ïöî)
  const sortedPopularArticles = [...popularArticles].sort((a, b) => {
    const scoreA = a.likes + a.dislikes;
    const scoreB = b.likes + b.dislikes;
    return scoreB - scoreA;
  });

  const totalPopularPages = Math.ceil(sortedPopularArticles.length / articlesPerPage);
  const currentPopularArticles = sortedPopularArticles.slice((currentPopularPage - 1) * articlesPerPage, currentPopularPage * articlesPerPage);

  // ÏµúÏã†Ïàú Ï†ïÎ†¨: id ÎÇ¥Î¶ºÏ∞®Ïàú
  const sortedLatestArticles = [...popularArticles].sort((a, b) => b.id - a.id);
  const totalLatestPages = Math.ceil(sortedLatestArticles.length / articlesPerPage);
  const currentLatestArticles = sortedLatestArticles.slice((currentLatestPage - 1) * articlesPerPage, currentLatestPage * articlesPerPage);

  // Ï£ºÏ†úÎ≥Ñ Ï†ïÎ†¨: Ìï¥Îãπ Ïπ¥ÌÖåÍ≥†Î¶¨, id ÎÇ¥Î¶ºÏ∞®Ïàú
  const filteredThemeArticles = (themePage === 'Ï†ïÏπò' ? politicsArticles : themePage === 'Í≥ºÌïô' ? scienceArticles : economyArticles).sort((a, b) => b.id - a.id);
  const totalThemePages = filteredThemeArticles.length ? Math.ceil(filteredThemeArticles.length / articlesPerPage) : 1;
  const currentThemeArticles = filteredThemeArticles.slice((currentThemePage - 1) * articlesPerPage, currentThemePage * articlesPerPage);
 
  return (
    <div className="App">
      <header className="app-header" style={{ position: 'fixed', top: 0, left: 0, width: '100%', zIndex: 100, backgroundColor: '#fff', height: '80px', display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '0 32px', boxShadow: '0 2px 4px rgba(0, 0, 0, 0.1)', boxSizing: 'border-box' }}>
        <div className="header-row">
          <div className="logo">
            <button className="logo-btn" onClick={() => setPage('main')} aria-label="Î©îÏù∏ÏúºÎ°ú Ïù¥Îèô" type="button">
              <img src={logo} alt="Agora Logo" className="logo-img" />
            </button>
          </div>
          <nav className="nav-tabs">
            <ul>
              <li>
                <button className="tab-btn" onClick={() => setPage('popular')}>Ïù∏Í∏∞</button>
              </li>
              <li>
                <button className="tab-btn" onClick={() => setPage('latest')}>ÏµúÏã†</button>
              </li>
              <li style={{ position: 'relative' }} ref={themeMenuRef}>
                <button className="tab-btn" onClick={() => setShowThemeMenu(prev => !prev)}>Ï£ºÏ†ú</button>
                {showThemeMenu && (
                  <div className="theme-dropdown">
                    <button className="theme-btn" onClick={() => { setThemePage('Ï†ïÏπò'); setPage('theme'); setShowThemeMenu(false); }}>Ï†ïÏπò</button>
                    <button className="theme-btn" onClick={() => { setThemePage('Í≥ºÌïô'); setPage('theme'); setShowThemeMenu(false); }}>Í≥ºÌïô</button>
                    <button className="theme-btn" onClick={() => { setThemePage('Í≤ΩÏ†ú'); setPage('theme'); setShowThemeMenu(false); }}>Í≤ΩÏ†ú</button>
                  </div>
                )}
              </li>
              <li>
                <button className="tab-btn write-btn" onClick={() => setPage('write')} type="button">Í∏ÄÏì∞Í∏∞</button>
              </li>
            </ul>
          </nav>
        </div>
        {/* Î°úÍ∑∏Ïù∏ Ï†ÑÏù¥Î©¥ Ïò§Î•∏Ï™ΩÏóê Sign in/Register Î≤ÑÌäº */}
        {!user && (
          <div style={{ display: 'flex', gap: '10px' }}>
            <button
              className="tab-btn"
              style={{ background: '#e5e7eb', color: '#111', border: 'none', borderRadius: '8px', padding: '8px 20px', fontWeight: 600 }}
              onClick={() => setPage('login')}
            >
              Sign in
            </button>
            <button
              className="tab-btn"
              style={{ background: '#111', color: '#fff', border: 'none', borderRadius: '8px', padding: '8px 20px', fontWeight: 600 }}
              onClick={() => setPage('register')}
            >
              Register
            </button>
          </div>
        )}
      </header>
      <hr className="header-divider" />
      <main className="content" style={page === 'newsDetail'
        ? { paddingTop: '80px', height: 'calc(100vh - 80px)', overflow: 'hidden', display: 'flex', flexDirection: 'row' }
        : { paddingTop: '80px', margin: 0, overflowY: 'auto', height: 'calc(100vh - 80px)' }
      }>
        {page === 'main' && (
          <>
            <section className="section" id="popular">
              <button className="section-link" onClick={() => setPage('popular')}>
                <div className="section-title">
                  <span className="main-title">Ïù∏Í∏∞Ïàúüî•</span>
                  <span className="sub-title">popularity</span>
                </div>
              </button>
              <div className="card-grid">
                {sortedPopularArticles.slice(0, 3).map((article) => (
                  <NewsCard
                    key={article.id}
                    title={article.title}
                    brief={article.brief}
                    imageURL={article.imageURL}
                    likes={article.likes}
                    dislikes={article.dislikes}
                    onClick={() => { setSelectedNews(article); setPage('newsDetail'); }}
                  />
                ))}
              </div>
            </section>
            <hr className="section-divider" />
            <section className="section" id="latest">
              <button className="section-link" onClick={() => setPage('latest')}>
                <div className="section-title">
                  <span className="main-title">ÏµúÏã†Ïàú‚ú®</span>
                  <span className="sub-title">latest</span>
                </div>
              </button>
              <div className="card-grid">
                {sortedLatestArticles.slice(0, 3).map((article) => (
                  <NewsCard
                    key={article.id}
                    title={article.title}
                    brief={article.brief}
                    imageURL={article.imageURL}
                    likes={article.likes}
                    dislikes={article.dislikes}
                    onClick={() => { setSelectedNews(article); setPage('newsDetail'); }}
                  />
                ))}
              </div>
            </section>
            <hr className="section-divider" />
            <section className="section" id="theme">
              <div className="section-title">
                <span className="main-title">Ï£ºÏ†úüìö</span>
                <span className="sub-title">theme</span>
              </div>
              <div className="card-grid theme-grid">
                <ThemeCard category="Ï†ïÏπò" onClick={() => { setThemePage('Ï†ïÏπò'); setPage('theme'); }} />
                <ThemeCard category="Í≥ºÌïô" onClick={() => { setThemePage('Í≥ºÌïô'); setPage('theme'); }} />
                <ThemeCard category="Í≤ΩÏ†ú" onClick={() => { setThemePage('Í≤ΩÏ†ú'); setPage('theme'); }} />
              </div>
            </section>
          </>
        )}
        {page === 'popular' && (
          <section className="popular-section">
            <h2 className="popular-title">Ïù∏Í∏∞ Í∏∞ÏÇ¨</h2>
            <div className="popular-list">
              {currentPopularArticles.map((article) => (
                <NewsCard
                  key={article.id}
                  title={article.title}
                  brief={article.brief}
                  imageURL={article.imageURL}
                  likes={article.likes}
                  dislikes={article.dislikes}
                  onClick={() => { setSelectedNews(article); setPage('newsDetail'); }}
                  horizontal
                />
              ))}
            </div>
            <Pagination totalPages={totalPopularPages} currentPage={currentPopularPage} setCurrentPage={setCurrentPopularPage} />
          </section>
        )}
        {page === 'latest' && (
          <section className="popular-section">
            <h2 className="popular-title">ÏµúÏã† Í∏∞ÏÇ¨</h2>
            <div className="popular-list">
              {currentLatestArticles.map((article) => (
                <NewsCard
                  key={article.id}
                  title={article.title}
                  brief={article.brief}
                  imageURL={article.imageURL}
                  likes={article.likes}
                  dislikes={article.dislikes}
                  onClick={() => { setSelectedNews(article); setPage('newsDetail'); }}
                  horizontal
                />
              ))}
            </div>
            <Pagination totalPages={totalLatestPages} currentPage={currentLatestPage} setCurrentPage={setCurrentLatestPage} />
          </section>
        )}
        {page === 'theme' && (
          <section className="theme-section">
            <h2 className="popular-title">{themePage} Í∏∞ÏÇ¨</h2>
            <div className="popular-list">
              {currentThemeArticles.map((article) => (
                <NewsCard
                  key={article.id}
                  title={article.title}
                  brief={article.brief}
                  imageURL={article.imageURL}
                  likes={article.likes}
                  dislikes={article.dislikes}
                  onClick={() => { setSelectedNews(article); setPage('newsDetail'); }}
                  horizontal
                />
              ))}
            </div>
            <Pagination totalPages={totalThemePages} currentPage={currentThemePage} setCurrentPage={setCurrentThemePage} />
          </section>
        )}
        {page === 'write' && <WritePage user={user} setPage={setPage} />}
        {page === 'newsDetail' && <NewsDetailPage news={selectedNews} />}
        {page === 'login' && <LoginPage onSubmit={() => setPage('main')} />}
        {page === 'register' && <RegisterPage setPage={setPage} />}
      </main>
    </div>
  );
}

function NewsCard({ title, brief, imageURL, likes, dislikes, onClick, horizontal }) {
  const [hover, setHover] = React.useState(false);
  if (horizontal) {
    return (
      <div
        className="news-card"
        onClick={onClick}
        onMouseEnter={() => setHover(true)}
        onMouseLeave={() => setHover(false)}
        style={{
          display: 'flex',
          flexDirection: 'row',
          alignItems: 'stretch',
          width: '700%',
          minWidth: 1380,
          minHeight: 290,
          maxHeight: 290,
          background: '#fff',
          borderRadius: '1rem',
          boxShadow: hover ? '0 8px 32px 0 rgba(0,0,0,0.18)' : '0 2px 4px rgba(98, 94, 94, 0.1)',
          marginBottom: 32,
          cursor: 'pointer',
          overflow: 'hidden',
          border: '1px solid rgb(112, 109, 109)',
          transition: 'box-shadow 0.2s',
        }}
      >
        {/* Ïù¥ÎØ∏ÏßÄ (ÏôºÏ™Ω 2/4) */}
        <div style={{ flex: 2, minWidth: 0, maxWidth: '40%', display: 'flex', alignItems: 'stretch', justifyContent: 'center', background: '#f3f4f6', padding: 0 }}>
          <img src={imageURL} alt="Í∏∞ÏÇ¨ Ïù¥ÎØ∏ÏßÄ" style={{ width: '100%', height: '100%', objectFit: 'cover', minHeight: 180, display: 'block', margin: 0, padding: 0, border: 0 }} />
        </div>
        {/* Ï†úÎ™©+ÏöîÏïΩ (Í∞ÄÏö¥Îç∞ 1/2) */}
        <div style={{ flex: 2, padding: '32px 32px 20px 40px', display: 'flex', flexDirection: 'column', justifyContent: 'center', height: '100%' }}>
          <div style={{ flex: 1, display: 'flex', alignItems: 'flex-end' }}>
            <h3 style={{ fontSize: '1.6rem', fontWeight: 700, margin: 0 }}>{title}</h3>
          </div>
          <div style={{ flex: 3, display: 'flex', alignItems: 'flex-start' }}>
            <p style={{ fontSize: '1.13rem', color: '#444', margin: 0 }}>{brief}</p>
          </div>
        </div>
        {/* Ï¢ãÏïÑÏöî/Ïã´Ïñ¥Ïöî (Ïò§Î•∏Ï™Ω 1/4) */}
        <div style={{ flex: 1, display: 'flex', flexDirection: 'column', justifyContent: 'flex-end', alignItems: 'flex-end', padding: '0 32px 24px 0', minWidth: 0 }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 22 }}>
            <span style={{ display: 'flex', alignItems: 'center', color: '#2563eb', fontWeight: 600, fontSize: '1.18rem' }}>
              <img src={thumbUpImg} alt="Ï¢ãÏïÑÏöî" className="thumb-icon" style={{ width: 28, height: 28, marginRight: 6 }} />
              {likes}
            </span>
            <span style={{ display: 'flex', alignItems: 'center', color: '#dc2626', fontWeight: 600, fontSize: '1.18rem' }}>
              <img src={thumbDownImg} alt="Ïã´Ïñ¥Ïöî" className="thumb-icon" style={{ width: 28, height: 28, marginRight: 6 }} />
              {dislikes}
            </span>
          </div>
        </div>
      </div>
    );
  }
  // Í∏∞Ï°¥ Ïπ¥Îìú Î†àÏù¥ÏïÑÏõÉ
  return (
    <div className="news-card" onClick={onClick} style={{ cursor: 'pointer' }}>
      <div className="image-wrapper">
        <img src={imageURL} alt="Í∏∞ÏÇ¨ Ïù¥ÎØ∏ÏßÄ" className="news-image" />
      </div>
      <h3>{title}</h3>
      <p className="news-brief">{brief}</p>
      <div className="reaction">
        <span>
          <img src={thumbUpImg} alt="Ï¢ãÏïÑÏöî" className="thumb-icon" />
          {likes}
        </span>
        <span>
          <img src={thumbDownImg} alt="Ïã´Ïñ¥Ïöî" className="thumb-icon" />
          {dislikes}
        </span>
      </div>
    </div>
  );
}

function ThemeCard({ category, onClick }) {
  const icons = {
    Ï†ïÏπò: 'üé§',
    Í≥ºÌïô: '‚öõÔ∏è',
    Í≤ΩÏ†ú: 'üí∞',
  };
  return (
    <button className="theme-card" onClick={onClick} type="button">
      <div className="icon">{icons[category]}</div>
      <h3>{category}</h3>
      <p>{category} Í¥ÄÎ†® Í∏∞ÏÇ¨Î°ú Ïù¥Îèô</p>
    </button>
  );
}

function Pagination({ totalPages, currentPage, setCurrentPage }) {
  const pages = [];
  for (let i = 1; i <= totalPages; i++) {
    pages.push(i);
  }
  return (
    <div className="pagination">
      {pages.map((num) => (
        <button
          key={num}
          className={num === currentPage ? 'active' : ''}
          onClick={() => setCurrentPage(num)}
        >
          {num}
        </button>
      ))}
    </div>
  );
}

export default App;